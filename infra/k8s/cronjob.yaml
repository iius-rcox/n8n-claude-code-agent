# CronJob: Claude Authentication Watchdog
# Feature: 007-teams-prompting
# User Story: US2 - Authentication Watchdog CronJob
# Purpose: Periodically check Claude authentication and alert on failures
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: claude-auth-watchdog
  namespace: claude-agent
  labels:
    app: claude-code-agent
    component: auth-watchdog
spec:
  # Schedule: Every 30 minutes
  schedule: "*/30 * * * *"

  # Prevent overlapping job runs
  concurrencyPolicy: Forbid

  # Allow 5 minutes for delayed start before skipping
  startingDeadlineSeconds: 300

  # Keep history for debugging
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3

  # Active (not suspended)
  suspend: false

  jobTemplate:
    spec:
      # No retries - notification sent on first failure
      backoffLimit: 0

      # Job must complete within 2 minutes
      activeDeadlineSeconds: 120

      template:
        metadata:
          labels:
            app: claude-code-agent
            component: auth-watchdog
            azure.workload.identity/use: "true"
        spec:
          serviceAccountName: claude-agent-sa
          restartPolicy: Never

          # Pod security context (matches main deployment)
          securityContext:
            runAsNonRoot: true
            runAsUser: 1001
            runAsGroup: 1001
            fsGroup: 1001
            seccompProfile:
              type: RuntimeDefault

          # Init container to copy session tokens
          initContainers:
            - name: copy-claude-session
              image: busybox:1.36
              command: ['sh', '-c', 'cp -r /claude-session-ro/. /home/claude-agent/.claude/']
              securityContext:
                allowPrivilegeEscalation: false
                capabilities:
                  drop:
                    - ALL
                readOnlyRootFilesystem: true
              resources:
                requests:
                  cpu: "10m"
                  memory: "16Mi"
                limits:
                  cpu: "100m"
                  memory: "64Mi"
              volumeMounts:
                - name: claude-session
                  mountPath: /claude-session-ro
                  readOnly: true
                - name: claude-home
                  mountPath: /home/claude-agent

          containers:
            - name: auth-check
              image: iiusacr.azurecr.io/claude-agent:v1.4.2-stdin-fix

              # Run authentication check script
              command:
                - bash
                - /opt/claude-agent/check-auth.sh

              securityContext:
                allowPrivilegeEscalation: false
                capabilities:
                  drop:
                    - ALL
                readOnlyRootFilesystem: true

              resources:
                requests:
                  cpu: "50m"
                  memory: "128Mi"
                limits:
                  memory: "512Mi"

              env:
                - name: POD_NAME
                  valueFrom:
                    fieldRef:
                      fieldPath: metadata.name
                - name: TEAMS_WEBHOOK_URL
                  valueFrom:
                    secretKeyRef:
                      name: teams-webhook
                      key: url
                - name: AUTH_CHECK_TIMEOUT
                  value: "30"
                # OAuth token for Claude authentication (same as main deployment)
                - name: CLAUDE_CODE_OAUTH_TOKEN
                  valueFrom:
                    secretKeyRef:
                      name: claude-oauth-token
                      key: token
                      optional: true

              volumeMounts:
                - name: claude-home
                  mountPath: /home/claude-agent
                - name: tmp
                  mountPath: /tmp

          volumes:
            - name: claude-session
              secret:
                secretName: claude-session
            - name: claude-home
              emptyDir: {}
            - name: tmp
              emptyDir: {}
