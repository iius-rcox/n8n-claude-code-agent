{
  "name": "Agent Dev Team - Feature Request Form",
  "nodes": [
    {
      "parameters": {
        "jsCode": "// Generate unique task ID\nconst timestamp = Date.now();\nconst random = Math.random().toString(36).substring(2, 8);\nconst taskId = `FEAT-${timestamp}-${random}`;\n\n// Get data from the current input (from Merge Form Results)\nconst currentInput = $input.first().json;\n\n// Get form data from Step 1 (Feature Request Form trigger)\nconst step1Data = $('Feature Request Form').first().json;\n\n// Get form data from Step 2 (Select Repository Dropdown or Fallback)\nconst step2Data = currentInput;\n\n// Merge form data - Step 1 fields + Step 2 repository selection\nconst body = {\n  ...step1Data,\n  ...step2Data\n};\n\n// Create task envelope\nconst taskEnvelope = {\n  task_id: taskId,\n  status: 'pending',\n  phase: 'intake',\n  title: body['Feature Title'] || body.title || 'Untitled',\n  description: body['Description'] || body.description || '',\n  priority: (body['Priority'] || body.priority || 'medium').toLowerCase(),\n  repository: body['Target Repository'] || body.repository || 'iius-rcox/n8n-claude-code-agent',\n  acceptance_criteria: body['Acceptance Criteria'] || body.acceptance_criteria || '',\n  created_at: new Date().toISOString(),\n  created_by: 'form',\n  phases: {\n    intake: { status: 'pending' },\n    planning: { status: 'pending' },\n    implementation: { status: 'pending' },\n    verification: { status: 'pending' },\n    review: { status: 'pending' },\n    release: { status: 'pending' }\n  },\n  retry_counts: {\n    verification: 0,\n    review: 0\n  },\n  error_history: [],\n  artifacts: {}\n};\n\nreturn [{\n  json: {\n    task_id: taskId,\n    task_envelope: taskEnvelope,\n    form_data: body\n  }\n}];"
      },
      "id": "generate-task",
      "name": "Generate Task ID & Envelope",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1120, 304]
    },
    {
      "parameters": {
        "method": "PUT",
        "url": "=https://iiusagentstore.blob.core.windows.net/agent-state/{{ $json.task_id }}/task-envelope.json{{ $env.AZURE_STORAGE_SAS_TOKEN }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "x-ms-blob-type", "value": "BlockBlob" },
            { "name": "Content-Type", "value": "application/json" },
            { "name": "x-ms-version", "value": "2020-10-02" }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "body": "={{ JSON.stringify($json.task_envelope, null, 2) }}",
        "options": { "response": { "response": { "fullResponse": true } } }
      },
      "id": "store-blob",
      "name": "Store Task Envelope (Blob)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1344, 208]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.TEAMS_WEBHOOK_URL || 'https://httpstat.us/200' }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [{ "name": "Content-Type", "value": "application/json" }]
        },
        "sendBody": true,
        "contentType": "raw",
        "body": "={\n  \"@type\": \"MessageCard\",\n  \"@context\": \"http://schema.org/extensions\",\n  \"themeColor\": \"0076D7\",\n  \"summary\": \"New Feature Request: {{ $json.task_id }}\",\n  \"sections\": [{\n    \"activityTitle\": \"New Feature Request Submitted\",\n    \"facts\": [\n      { \"name\": \"Task ID\", \"value\": \"{{ $json.task_id }}\" },\n      { \"name\": \"Title\", \"value\": \"{{ $json.task_envelope.title }}\" },\n      { \"name\": \"Priority\", \"value\": \"{{ $json.task_envelope.priority }}\" },\n      { \"name\": \"Repository\", \"value\": \"{{ $json.task_envelope.repository }}\" },\n      { \"name\": \"Status\", \"value\": \"Queued for Intake\" }\n    ],\n    \"markdown\": true\n  }]\n}",
        "options": { "response": { "response": { "fullResponse": true } } }
      },
      "id": "notify-teams",
      "name": "Notify Teams",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1344, 400],
      "continueOnFail": true
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineAll",
        "options": {}
      },
      "id": "merge-results",
      "name": "Merge Results",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [1568, 304]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "response-msg",
              "name": "message",
              "value": "=Your feature request **{{ $('Generate Task ID & Envelope').item.json.task_id }}** has been submitted successfully!\\n\\nYou will receive Teams notifications as it progresses through:\\n- Intake (specification)\\n- Planning\\n- Implementation\\n- Verification\\n- Review\\n- Release",
              "type": "string"
            },
            {
              "id": "task-id",
              "name": "task_id",
              "value": "={{ $('Generate Task ID & Envelope').item.json.task_id }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "set-response",
      "name": "Prepare Response",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [1792, 304]
    },
    {
      "parameters": {
        "workflowId": { "__rl": true, "mode": "id", "value": "ZU4cSyG5OMC0EmpY" },
        "options": { "waitForSubWorkflow": false }
      },
      "id": "call-orchestrator",
      "name": "Start Orchestration",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [2016, 304]
    },
    {
      "id": "form-trigger",
      "name": "Feature Request Form",
      "type": "n8n-nodes-base.formTrigger",
      "typeVersion": 2.2,
      "position": [0, 304],
      "webhookId": "feature-request-form",
      "parameters": {
        "path": "feature-request",
        "formTitle": "Feature Request",
        "formDescription": "Submit a new feature request for the autonomous dev team",
        "formFields": {
          "values": [
            { "fieldLabel": "Feature Title", "fieldType": "text", "requiredField": true, "placeholder": "Brief title for the feature" },
            { "fieldLabel": "Description", "fieldType": "textarea", "requiredField": true, "placeholder": "Detailed description of what you need" },
            { "fieldLabel": "Priority", "fieldType": "dropdown", "requiredField": true, "fieldOptions": { "values": [{ "option": "low" }, { "option": "medium" }, { "option": "high" }, { "option": "critical" }] } },
            { "fieldLabel": "Acceptance Criteria", "fieldType": "textarea", "requiredField": true, "placeholder": "How will we know when this feature is complete?" }
          ]
        },
        "responseMode": "lastNode"
      }
    },
    {
      "id": "fetch-repos",
      "name": "Read Cached Repos",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [224, 304],
      "parameters": {
        "method": "GET",
        "url": "=https://iiusagentstore.blob.core.windows.net/agent-state/repos.json{{ $env.AZURE_STORAGE_SAS_TOKEN }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "x-ms-version", "value": "2020-10-02" }
          ]
        },
        "options": { "response": { "response": { "fullResponse": false } } }
      },
      "continueOnFail": true
    },
    {
      "id": "transform-repos",
      "name": "Transform Repo Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [448, 304],
      "parameters": {
        "jsCode": "// Read cached repos from blob storage\nconst input = $input.first();\n\n// Get the original form data from Step 1\nconst formData = $('Feature Request Form').first().json;\n\n// Check if data came back as binary (Azure Blob returns application/octet-stream)\nlet blobData = null;\nif (input.binary && input.binary.data) {\n  // Parse the base64 binary data\n  const base64Data = input.binary.data.data;\n  const jsonString = Buffer.from(base64Data, 'base64').toString('utf8');\n  try {\n    blobData = JSON.parse(jsonString);\n  } catch (e) {\n    blobData = null;\n  }\n} else if (input.json) {\n  // Data came back as JSON directly\n  blobData = input.json;\n}\n\n// Check if we got valid data with dropdownOptions\nconst hasValidData = blobData && blobData.dropdownOptions && blobData.dropdownOptions.length > 0;\n\nif (hasValidData) {\n  return [{\n    json: {\n      dropdownOptions: blobData.dropdownOptions,\n      repoCount: blobData.repoCount || blobData.dropdownOptions.length,\n      success: true,\n      lastUpdated: blobData.lastUpdated || 'unknown',\n      formData: formData\n    }\n  }];\n} else {\n  // Blob doesn't exist, is empty, or errored - use fallback path\n  return [{\n    json: {\n      dropdownOptions: [],\n      repoCount: 0,\n      success: false,\n      error: blobData ? 'No repos in cache' : 'Repo cache not found',\n      formData: formData\n    }\n  }];\n}"
      }
    },
    {
      "id": "check-repos",
      "name": "Check Repos Loaded",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [672, 304],
      "parameters": {
        "conditions": {
          "options": { "caseSensitive": true, "leftValue": "", "typeValidation": "strict" },
          "conditions": [
            { "id": "check-success", "leftValue": "={{ $json.success }}", "rightValue": true, "operator": { "type": "boolean", "operation": "equals" } }
          ],
          "combinator": "and"
        }
      }
    },
    {
      "id": "form-dropdown",
      "name": "Select Repository (Dropdown)",
      "type": "n8n-nodes-base.form",
      "typeVersion": 1,
      "position": [896, 200],
      "parameters": {
        "operation": "page",
        "defineForm": "json",
        "jsonOutput": "={{ JSON.stringify([{\"fieldLabel\": \"Target Repository\", \"fieldType\": \"dropdown\", \"requiredField\": true, \"fieldOptions\": {\"values\": $json.dropdownOptions}}]) }}",
        "options": { "formTitle": "Select Target Repository", "formDescription": "Choose the repository for this feature request" }
      }
    },
    {
      "id": "merge-form",
      "name": "Merge Form Results",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [1120, 400],
      "parameters": {
        "mode": "append",
        "options": {}
      }
    },
    {
      "id": "form-fallback",
      "name": "Select Repository (Fallback)",
      "type": "n8n-nodes-base.form",
      "typeVersion": 1,
      "position": [896, 500],
      "parameters": {
        "operation": "page",
        "defineForm": "json",
        "jsonOutput": "[{\"fieldLabel\": \"Target Repository (Unable to load list - enter manually)\", \"fieldType\": \"text\", \"requiredField\": true, \"placeholder\": \"iius-rcox/repository-name\"}]",
        "options": { "formTitle": "Select Target Repository", "formDescription": "Enter the repository name manually" }
      }
    }
  ],
  "connections": {
    "Generate Task ID & Envelope": {
      "main": [[{ "node": "Store Task Envelope (Blob)", "type": "main", "index": 0 }, { "node": "Notify Teams", "type": "main", "index": 0 }]]
    },
    "Store Task Envelope (Blob)": {
      "main": [[{ "node": "Merge Results", "type": "main", "index": 0 }]]
    },
    "Notify Teams": {
      "main": [[{ "node": "Merge Results", "type": "main", "index": 1 }]]
    },
    "Merge Results": {
      "main": [[{ "node": "Prepare Response", "type": "main", "index": 0 }]]
    },
    "Feature Request Form": {
      "main": [[{ "node": "Read Cached Repos", "type": "main", "index": 0 }]]
    },
    "Prepare Response": {
      "main": [[{ "node": "Start Orchestration", "type": "main", "index": 0 }]]
    },
    "Read Cached Repos": {
      "main": [[{ "node": "Transform Repo Response", "type": "main", "index": 0 }]]
    },
    "Transform Repo Response": {
      "main": [[{ "node": "Check Repos Loaded", "type": "main", "index": 0 }]]
    },
    "Check Repos Loaded": {
      "main": [
        [{ "node": "Select Repository (Dropdown)", "type": "main", "index": 0 }],
        [{ "node": "Select Repository (Fallback)", "type": "main", "index": 0 }]
      ]
    },
    "Select Repository (Dropdown)": {
      "main": [[{ "node": "Merge Form Results", "type": "main", "index": 0 }]]
    },
    "Select Repository (Fallback)": {
      "main": [[{ "node": "Merge Form Results", "type": "main", "index": 1 }]]
    },
    "Merge Form Results": {
      "main": [[{ "node": "Generate Task ID & Envelope", "type": "main", "index": 0 }]]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner"
  },
  "meta": {
    "description": "Two-step feature request form with cached repository dropdown. Step 1 collects feature details. Step 2 reads repos from Azure Blob cache (populated by hourly sync workflow), with fallback to text input if cache is unavailable.",
    "version": "3.0.2",
    "feature": "012-dynamic-repo-dropdown",
    "architecture": "cached-blob"
  }
}
