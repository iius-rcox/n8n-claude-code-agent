# Implementation Plan: Automated Testing

**Branch**: `008-automated-testing` | **Date**: 2026-01-15 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/008-automated-testing/spec.md`

## Summary

Implement automated testing infrastructure for the Claude Code Agent system, covering HTTP server unit tests (Node.js), shell script tests (BATS), integration tests, and CI/CD pipeline integration via GitHub Actions. Tests must run without network access or Claude credentials by mocking external dependencies.

## Technical Context

**Language/Version**: Node.js 20.x LTS (server.js), Bash (shell scripts)
**Primary Dependencies**: Jest (unit tests), BATS (shell tests), supertest (HTTP testing)
**Storage**: N/A (no persistent storage for tests)
**Testing**: Jest + supertest for Node.js, BATS for shell scripts
**Target Platform**: Linux (CI runners), Windows (local dev optional)
**Project Type**: Single project with infra/docker source code
**Performance Goals**: CI pipeline completes in <5 minutes
**Constraints**: Tests must run without network, credentials, or Claude CLI
**Scale/Scope**: ~15 test files covering server.js, check-auth.sh, notify.sh

## Implementation Approach

**Type**: Scripts

**Rationale**: This feature creates automated tests that run repeatedly in CI/CD pipelines. Per Constitution VI (Pragmatic Automation), CI/CD pipeline steps MUST be scripted with proper exit codes and error handling. Tests are inherently repeatable tasks that benefit from scripting.

**Artifacts**:
- `tests/` directory with unit and integration tests
- `package.json` with test scripts and dependencies
- `.github/workflows/test.yml` for CI pipeline
- Mock utilities for Claude CLI and curl

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Evidence |
|-----------|--------|----------|
| I. Spec-First Development | PASS | spec.md complete with 4 user stories, 14 FRs, 7 SCs |
| II. Security by Default | PASS | Tests don't handle credentials; mocks prevent real auth calls |
| III. Phase Gates | PASS | Following Specify → Plan → Tasks → Implement sequence |
| IV. Infrastructure as Code | PASS | Test configs in package.json, CI in .github/workflows/ |
| V. Automation & Observability | PASS | Tests provide automated validation; CI provides observability |
| VI. Pragmatic Automation | PASS | CI/CD = Scripts per decision matrix |

**Gate Result**: PASS - No violations. Proceeding to Phase 0.

## Project Structure

### Documentation (this feature)

```text
specs/008-automated-testing/
├── plan.md              # This file
├── research.md          # Phase 0 output
├── data-model.md        # Phase 1 output (minimal - test entities)
├── quickstart.md        # Phase 1 output (running tests locally)
├── contracts/           # Phase 1 output (test contracts/fixtures)
└── tasks.md             # Phase 2 output (generated by /speckit.tasks)
```

### Source Code (repository root)

```text
infra/
├── docker/
│   ├── server.js        # HTTP server (TEST TARGET)
│   ├── check-auth.sh    # Auth check script (TEST TARGET)
│   ├── notify.sh        # Teams notification (TEST TARGET)
│   └── Dockerfile
└── k8s/
    └── *.yaml

tests/
├── unit/
│   ├── server.test.js   # HTTP server unit tests
│   └── fixtures/        # Test fixtures (mock responses)
├── scripts/
│   ├── check-auth.bats  # BATS tests for check-auth.sh
│   └── notify.bats      # BATS tests for notify.sh
├── integration/
│   └── http-flow.test.js # End-to-end HTTP tests
└── mocks/
    ├── claude-mock.sh   # Mock Claude CLI for shell tests
    └── spawnSync.js     # Mock spawnSync for Node tests

.github/
└── workflows/
    └── test.yml         # CI pipeline

package.json             # Test dependencies and scripts
```

**Structure Decision**: Single project structure. Tests reside in `tests/` at repository root. Source code under test is in `infra/docker/`. This follows standard Node.js project conventions.

## Post-Design Constitution Re-Check

*Re-evaluated after Phase 1 design completion.*

| Principle | Status | Post-Design Evidence |
|-----------|--------|----------------------|
| I. Spec-First Development | PASS | Design artifacts align with spec user stories |
| II. Security by Default | PASS | No credentials in test fixtures; mocks used throughout |
| III. Phase Gates | PASS | Phase 0 and Phase 1 complete; ready for Phase 2 (tasks) |
| IV. Infrastructure as Code | PASS | CI workflow defined; package.json scripts documented |
| V. Automation & Observability | PASS | Test coverage reports provide observability |
| VI. Pragmatic Automation | PASS | Scripts for repeatable CI/CD; quickstart.md for local setup |

**Post-Design Gate Result**: PASS - Design complete. Ready for task generation.

## Complexity Tracking

> No violations requiring justification. Test infrastructure follows standard patterns.

| Violation | Why Needed | Simpler Alternative Rejected Because |
|-----------|------------|-------------------------------------|
| N/A | N/A | N/A |
