# Implementation Plan: Teams Prompting

**Branch**: `007-teams-prompting` | **Date**: 2026-01-15 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/007-teams-prompting/spec.md`

## Summary

Enable proactive Teams notifications for Claude reauthentication by:
1. Creating a Microsoft Teams incoming webhook workflow
2. Storing the webhook URL in Kubernetes secret
3. Deploying a CronJob to periodically check Claude authentication
4. Verifying end-to-end n8n integration

The authentication check and notification scripts already exist in the container image (Sprint 4). This sprint focuses on Teams workflow creation, CronJob deployment, and integration verification.

## Technical Context

**Language/Version**: Bash (scripts already in container), YAML (Kubernetes manifests)
**Primary Dependencies**: Microsoft Teams (webhook), Kubernetes CronJob, existing `check-auth.sh` and `notify.sh` scripts
**Storage**: N/A (stateless CronJob)
**Testing**: Manual verification via kubectl and Teams channel observation
**Target Platform**: AKS cluster (dev-aks), Microsoft Teams
**Project Type**: Infrastructure/Kubernetes configuration
**Performance Goals**: Notifications delivered within 30 seconds of auth failure detection
**Constraints**: CronJob must not overlap (concurrencyPolicy: Forbid), must use same security context as main deployment
**Scale/Scope**: Single CronJob, single Teams channel

## Implementation Approach

**Type**: Hybrid (Runbook for Teams webhook setup + Kubernetes manifest for CronJob)

**Rationale**:
- Teams webhook creation is a one-time manual setup in the Teams admin console - documenting in runbook is simpler than scripting
- CronJob is a repeated scheduled task that MUST be scripted as a Kubernetes manifest
- n8n integration test is a one-time verification documented in runbook

**Artifacts**:
- `quickstart.md`: Step-by-step guide for Teams webhook creation, secret setup, and verification
- `infra/k8s/cronjob.yaml`: CronJob manifest for claude-auth-watchdog

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Evidence |
|-----------|--------|----------|
| I. Spec-First Development | ✅ PASS | spec.md completed with 14 requirements, 7 success criteria |
| II. Security by Default | ✅ PASS | CronJob uses same security context as deployment (non-root, readOnlyRootFilesystem, dropped capabilities) |
| III. Phase Gates | ✅ PASS | Specify → Plan → Tasks sequence followed |
| IV. Infrastructure as Code | ✅ PASS | CronJob manifest stored in repository |
| V. Automation & Observability | ✅ PASS | CronJob sends Teams alerts on auth failure; exit code 57 for routing |
| VI. Pragmatic Automation | ✅ PASS | Hybrid approach: runbook for one-time setup, manifest for scheduled job |

**Gate Result**: PASS - No violations

## Project Structure

### Documentation (this feature)

```text
specs/007-teams-prompting/
├── plan.md              # This file
├── research.md          # Phase 0 output - Teams webhook patterns
├── data-model.md        # Phase 1 output - CronJob configuration model
├── quickstart.md        # Phase 1 output - Setup and verification guide
├── contracts/           # Phase 1 output - CronJob manifest specification
└── tasks.md             # Phase 2 output (generated by /speckit.tasks)
```

### Source Code (repository root)

```text
infra/
├── docker/
│   ├── check-auth.sh    # Existing - authentication check script
│   └── notify.sh        # Existing - Teams notification script
└── k8s/
    ├── deployment.yaml  # Existing - references teams-webhook secret
    ├── service.yaml     # Existing - ClusterIP service for n8n
    └── cronjob.yaml     # NEW - Authentication watchdog CronJob
```

**Structure Decision**: Kubernetes CronJob manifest added to existing `infra/k8s/` directory. No new directories needed.

## Complexity Tracking

> **No violations - table empty**

| Violation | Why Needed | Simpler Alternative Rejected Because |
|-----------|------------|-------------------------------------|
| - | - | - |
