{
  "name": "QA Verification",
  "nodes": [
    {
      "parameters": {},
      "id": "trigger_subworkflow",
      "name": "Sub-Workflow Trigger",
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1,
      "position": [240, 300],
      "notes": "T099: Input: task_id, pr_url"
    },
    {
      "parameters": {
        "jsCode": "// T100: Prepare to download spec.md for acceptance criteria\nconst data = $input.first().json;\n\nif (!data.task_id || !data.pr_url) {\n  throw new Error('Missing required fields: task_id and pr_url');\n}\n\nreturn [{\n  json: {\n    operation: 'download',\n    container: 'agent-spec',\n    blob_path: `${data.task_id}/spec.md`,\n    task_id: data.task_id,\n    pr_url: data.pr_url\n  }\n}];"
      },
      "id": "code_prepare_download",
      "name": "Prepare Spec Download",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [460, 300],
      "notes": "T100: Prepare download request for spec.md"
    },
    {
      "parameters": {
        "workflowId": "={{ $env.BLOB_STATE_MANAGER_WORKFLOW_ID }}",
        "options": {}
      },
      "id": "call_blob_download",
      "name": "Download spec.md",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.1,
      "position": [680, 300],
      "notes": "T100: Download spec.md via Blob State Manager"
    },
    {
      "parameters": {
        "jsCode": "// T101: Build QA verification prompt\nconst downloadResult = $input.first().json;\nconst inputData = $('Sub-Workflow Trigger').first().json;\n\nif (!downloadResult.success) {\n  throw new Error(`Failed to download spec.md: ${downloadResult.error || 'Unknown error'}`);\n}\n\nconst specContent = downloadResult.content;\n\n// Extract acceptance criteria from spec.md\nconst criteriaMatch = specContent.match(/## Acceptance Criteria[\\s\\S]*?(?=##|$)/i);\nconst acceptanceCriteria = criteriaMatch ? criteriaMatch[0] : 'No acceptance criteria found';\n\n// Build the system prompt with QA Agent verification behavior\nconst systemPrompt = `You are a Senior QA Engineer. Your role is to verify that code changes meet the specification requirements.\n\n## Behavior: Verification\n\nYou will:\n1. **Run Tests**: Execute the test suite and report results\n2. **Check Acceptance Criteria**: Verify each criterion is satisfied\n3. **Identify Issues**: Report any problems found\n4. **Security Check**: Look for obvious security vulnerabilities\n\n## Output Format\n\nYour response MUST include a YAML block with the verification report:\n\n\\`\\`\\`yaml\ntest_results:\n  passed: <number>\n  failed: <number>\n  skipped: <number>\n  \ncriteria_status:\n  - criterion: \"<acceptance criterion text>\"\n    status: passed | failed | untested\n    evidence: \"<how you verified this>\"\n    \nissues_found:\n  - severity: critical | major | minor\n    description: \"<issue description>\"\n    location: \"<file:line or test name>\"\n    suggested_fix: \"<optional suggestion>\"\n    \nrecommendation: approve | request_changes\nfeedback_for_dev: \"<specific items to address if request_changes>\"\n\\`\\`\\`\n\n## Guidelines\n\n- Run \\`npm test\\` or appropriate test command\n- Verify EACH acceptance criterion explicitly\n- If tests fail, include failure messages\n- Flag any security concerns (exposed secrets, injection risks)\n- Be specific in feedback - reference files and line numbers`;\n\n// Build the user prompt\nconst userPrompt = `## Task\n\nVerify the implementation meets the specification requirements.\n\n## PR Information\n\n- Task ID: ${inputData.task_id}\n- PR URL: ${inputData.pr_url}\n\n## Specification\n\n${specContent}\n\n## Acceptance Criteria to Verify\n\n${acceptanceCriteria}\n\n---\n\nPlease run tests, verify each acceptance criterion, and provide your verification report.`;\n\nreturn [{\n  json: {\n    task_id: inputData.task_id,\n    pr_url: inputData.pr_url,\n    spec_content: specContent,\n    acceptance_criteria: acceptanceCriteria,\n    prompt: userPrompt,\n    system_prompt: systemPrompt,\n    agent_role: 'qa'\n  }\n}];"
      },
      "id": "code_build_prompt",
      "name": "Build Verification Prompt",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [900, 300],
      "notes": "T101: Build prompt using qa-agent.md template"
    },
    {
      "parameters": {
        "workflowId": "={{ $env.AGENT_RUNNER_WORKFLOW_ID }}",
        "options": {}
      },
      "id": "call_agent_runner",
      "name": "Call Agent Runner",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.1,
      "position": [1120, 300],
      "notes": "T102: Call Agent Runner with agent_role=qa"
    },
    {
      "parameters": {
        "jsCode": "// T103: Parse verification report from output\nconst agentResponse = $input.first().json;\nconst previousData = $('Build Verification Prompt').first().json;\n\nif (!agentResponse.success) {\n  return [{\n    json: {\n      success: false,\n      task_id: previousData.task_id,\n      error: agentResponse.error || 'Agent Runner failed',\n      recommendation: 'error'\n    }\n  }];\n}\n\nconst output = agentResponse.output || '';\n\n// Parse the YAML verification report\nconst yamlMatch = output.match(/```yaml\\n([\\s\\S]*?)```/);\n\nlet report = {\n  test_results: { passed: 0, failed: 0, skipped: 0 },\n  criteria_status: [],\n  issues_found: [],\n  recommendation: 'request_changes',\n  feedback_for_dev: 'Unable to parse verification report'\n};\n\nif (yamlMatch) {\n  const yamlContent = yamlMatch[1];\n  \n  // Parse test_results\n  const passedMatch = yamlContent.match(/passed:\\s*(\\d+)/);\n  const failedMatch = yamlContent.match(/failed:\\s*(\\d+)/);\n  const skippedMatch = yamlContent.match(/skipped:\\s*(\\d+)/);\n  \n  report.test_results = {\n    passed: passedMatch ? parseInt(passedMatch[1]) : 0,\n    failed: failedMatch ? parseInt(failedMatch[1]) : 0,\n    skipped: skippedMatch ? parseInt(skippedMatch[1]) : 0\n  };\n  \n  // Parse recommendation\n  const recMatch = yamlContent.match(/recommendation:\\s*(approve|request_changes)/);\n  report.recommendation = recMatch ? recMatch[1] : 'request_changes';\n  \n  // Parse feedback\n  const feedbackMatch = yamlContent.match(/feedback_for_dev:\\s*[\"']?([^\"'\\n]+)[\"']?/);\n  report.feedback_for_dev = feedbackMatch ? feedbackMatch[1].trim() : '';\n  \n  // Parse issues (simplified)\n  const issuesMatch = yamlContent.match(/issues_found:[\\s\\S]*?(?=recommendation:|$)/);\n  if (issuesMatch) {\n    const severityMatches = issuesMatch[0].match(/severity:\\s*(critical|major|minor)/g);\n    if (severityMatches) {\n      report.issues_found = severityMatches.map(m => ({\n        severity: m.replace('severity:', '').trim()\n      }));\n    }\n  }\n}\n\n// Determine if passed\nconst passed = report.recommendation === 'approve' && report.test_results.failed === 0;\n\nreturn [{\n  json: {\n    success: true,\n    task_id: previousData.task_id,\n    pr_url: previousData.pr_url,\n    passed: passed,\n    report: report,\n    recommendation: report.recommendation,\n    test_results: report.test_results,\n    issues_count: report.issues_found.length,\n    feedback: report.feedback_for_dev,\n    raw_output: output\n  }\n}];"
      },
      "id": "code_parse_report",
      "name": "Parse Verification Report",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1340, 300],
      "notes": "T103: Parse verification report from output"
    },
    {
      "parameters": {
        "jsCode": "// T105: Prepare upload for verification report\nconst data = $input.first().json;\n\n// Get cycle count from task envelope (would need to fetch first in real impl)\nconst cycle = 1; // Simplified - would track from envelope\n\nconst reportContent = JSON.stringify({\n  task_id: data.task_id,\n  pr_url: data.pr_url,\n  timestamp: new Date().toISOString(),\n  cycle: cycle,\n  passed: data.passed,\n  recommendation: data.recommendation,\n  test_results: data.test_results,\n  issues_count: data.issues_count,\n  feedback: data.feedback\n}, null, 2);\n\nreturn [{\n  json: {\n    operation: 'upload',\n    container: 'agent-verification',\n    blob_path: `${data.task_id}/verification-report-${cycle}.json`,\n    content: reportContent,\n    content_type: 'application/json',\n    task_id: data.task_id,\n    passed: data.passed,\n    recommendation: data.recommendation,\n    feedback: data.feedback,\n    pr_url: data.pr_url\n  }\n}];"
      },
      "id": "code_prepare_upload",
      "name": "Prepare Report Upload",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1560, 300],
      "notes": "T105: Build upload request for verification report"
    },
    {
      "parameters": {
        "workflowId": "={{ $env.BLOB_STATE_MANAGER_WORKFLOW_ID }}",
        "options": {}
      },
      "id": "call_blob_upload",
      "name": "Upload Verification Report",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.1,
      "position": [1780, 300],
      "notes": "T105: Upload report to agent-verification container"
    },
    {
      "parameters": {
        "conditions": {
          "options": { "caseSensitive": true, "leftValue": "", "typeValidation": "strict" },
          "conditions": [
            { "leftValue": "={{ $('Prepare Report Upload').first().json.passed }}", "rightValue": true, "operator": { "type": "boolean", "operation": "equals" } }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "if_passed",
      "name": "Verification Passed?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [2000, 300],
      "notes": "T107: Route based on verification result"
    },
    {
      "parameters": {
        "jsCode": "// Return passed result\nconst data = $('Prepare Report Upload').first().json;\n\nreturn [{\n  json: {\n    success: true,\n    task_id: data.task_id,\n    phase: 'verification',\n    passed: true,\n    recommendation: 'approve',\n    pr_url: data.pr_url,\n    report_path: `agent-verification/${data.task_id}/verification-report-1.json`\n  }\n}];"
      },
      "id": "code_return_passed",
      "name": "Return Passed",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2220, 200],
      "notes": "T107: Return passed with approval"
    },
    {
      "parameters": {
        "jsCode": "// Return failed result with feedback\nconst data = $('Prepare Report Upload').first().json;\n\nreturn [{\n  json: {\n    success: true,\n    task_id: data.task_id,\n    phase: 'verification',\n    passed: false,\n    recommendation: data.recommendation,\n    pr_url: data.pr_url,\n    feedback: data.feedback,\n    report_path: `agent-verification/${data.task_id}/verification-report-1.json`\n  }\n}];"
      },
      "id": "code_return_failed",
      "name": "Return Failed",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2220, 400],
      "notes": "T107: Return failed with feedback for routing"
    },
    {
      "parameters": {},
      "id": "error_trigger",
      "name": "Error Trigger",
      "type": "n8n-nodes-base.errorTrigger",
      "typeVersion": 1,
      "position": [240, 500],
      "notes": "Catch workflow errors"
    },
    {
      "parameters": {
        "jsCode": "// Handle workflow errors\nconst error = $input.first().json;\nconst inputData = $('Sub-Workflow Trigger').first().json;\n\nreturn [{\n  json: {\n    success: false,\n    task_id: inputData?.task_id || 'unknown',\n    phase: 'verification',\n    passed: false,\n    error: error.message || 'Unknown error in QA Verification workflow'\n  }\n}];"
      },
      "id": "code_handle_error",
      "name": "Handle Error",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [460, 500]
    }
  ],
  "connections": {
    "Sub-Workflow Trigger": {
      "main": [
        [{ "node": "Prepare Spec Download", "type": "main", "index": 0 }]
      ]
    },
    "Prepare Spec Download": {
      "main": [
        [{ "node": "Download spec.md", "type": "main", "index": 0 }]
      ]
    },
    "Download spec.md": {
      "main": [
        [{ "node": "Build Verification Prompt", "type": "main", "index": 0 }]
      ]
    },
    "Build Verification Prompt": {
      "main": [
        [{ "node": "Call Agent Runner", "type": "main", "index": 0 }]
      ]
    },
    "Call Agent Runner": {
      "main": [
        [{ "node": "Parse Verification Report", "type": "main", "index": 0 }]
      ]
    },
    "Parse Verification Report": {
      "main": [
        [{ "node": "Prepare Report Upload", "type": "main", "index": 0 }]
      ]
    },
    "Prepare Report Upload": {
      "main": [
        [{ "node": "Upload Verification Report", "type": "main", "index": 0 }]
      ]
    },
    "Upload Verification Report": {
      "main": [
        [{ "node": "Verification Passed?", "type": "main", "index": 0 }]
      ]
    },
    "Verification Passed?": {
      "main": [
        [{ "node": "Return Passed", "type": "main", "index": 0 }],
        [{ "node": "Return Failed", "type": "main", "index": 0 }]
      ]
    },
    "Error Trigger": {
      "main": [
        [{ "node": "Handle Error", "type": "main", "index": 0 }]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "saveManualExecutions": true,
    "callerPolicy": "any",
    "errorWorkflow": ""
  },
  "staticData": null,
  "tags": [
    { "name": "stage-4" },
    { "name": "qa-agent" },
    { "name": "autonomous-agents" }
  ],
  "pinData": {},
  "meta": {
    "templateId": "qa-verification",
    "instanceId": "autonomous-dev-team"
  }
}
